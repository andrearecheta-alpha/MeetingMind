<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MeetingMind â€” Live Transcription</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0f1117;
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: #1a1d27;
      border-bottom: 1px solid #2d3148;
      padding: 0 2rem;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo { display: flex; align-items: center; gap: 0.6rem; }
    .logo-icon {
      width: 26px; height: 26px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
    }
    .logo-text { font-size: 0.95rem; font-weight: 600; color: #f1f5f9; }

    /* â”€â”€ Status pill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-pill { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: #94a3b8; }
    .status-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: #475569;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .status-dot.connecting  { background: #94a3b8; animation: pulse-dot 1.4s ease-in-out infinite; }
    .status-dot.connected   { background: #3b82f6; }
    .status-dot.live        { background: #22c55e; box-shadow: 0 0 6px #22c55e88; }
    .status-dot.error,
    .status-dot.disconnected { background: #ef4444; }

    #btn-reconnect {
      background: none; border: 1px solid #334155; color: #94a3b8;
      font-size: 0.68rem; font-weight: 600; padding: 0.15rem 0.5rem;
      border-radius: 4px; cursor: pointer; transition: all 0.15s; display: none;
    }
    #btn-reconnect:hover { color: #e2e8f0; border-color: #6366f1; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      flex: 1; display: flex; flex-direction: column;
      max-height: calc(100vh - 52px); overflow: hidden;
    }

    /* â”€â”€ Controls bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .controls {
      background: #1a1d27; border-bottom: 1px solid #2d3148;
      padding: 0.6rem 2rem; display: flex; align-items: center;
      gap: 0.8rem; flex-wrap: wrap;
    }
    .ctrl-sep { width: 1px; height: 20px; background: #2d3148; flex-shrink: 0; }

    button {
      cursor: pointer; border: none; border-radius: 6px;
      font-size: 0.78rem; font-weight: 600;
      padding: 0.42rem 1rem; transition: all 0.15s; white-space: nowrap;
    }

    #btn-start { background: #6366f1; color: white; }
    #btn-start:hover:not(:disabled) { background: #4f46e5; }

    #btn-stop  { background: #1e2235; color: #64748b; border: 1px solid #2d3148; }
    #btn-stop:hover:not(:disabled)  { background: #ef4444; color: white; border-color: #ef4444; }

    #btn-reset { background: #1e2235; color: #64748b; border: 1px solid #2d3148; }
    #btn-reset:hover { background: #334155; color: #94a3b8; border-color: #475569; }

    button:disabled { opacity: 0.38; cursor: not-allowed; }

    .ctrl-label {
      font-size: 0.7rem; font-weight: 600; color: #475569;
      letter-spacing: 0.04em; text-transform: uppercase; white-space: nowrap; flex-shrink: 0;
    }

    select.ctrl-select {
      background: #0d0f18; border: 1px solid #2d3148; color: #cbd5e1;
      border-radius: 6px; padding: 0.38rem 0.65rem; font-size: 0.78rem;
      max-width: 220px; cursor: pointer; transition: border-color 0.15s; appearance: auto;
    }
    select.ctrl-select:hover { border-color: #475569; }
    select.ctrl-select:focus { outline: none; border-color: #6366f1; }
    select.ctrl-select option { background: #1a1d27; color: #e2e8f0; }

    .elapsed {
      margin-left: auto; font-size: 0.73rem; color: #475569;
      font-variant-numeric: tabular-nums; font-weight: 600; flex-shrink: 0;
    }

    /* â”€â”€ Error banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .error-banner {
      background: #200d0d; border-bottom: 1px solid #7f1d1d;
      padding: 0.45rem 2rem; font-size: 0.78rem; color: #fca5a5;
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
    }
    .error-banner button { background: none; color: #fca5a5; font-size: 0.85rem; padding: 0 0.3rem; }
    .error-banner button:hover { color: #fff; }

    /* â”€â”€ RMS meter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #rms-meter-wrap {
      display: none; align-items: center; gap: 0.5rem;
      padding: 3px 2rem; background: #0d0f18;
      border-bottom: 1px solid #1e2235; font-size: 0.68rem; color: #475569;
    }
    .rms-label { flex-shrink: 0; font-weight: 600; letter-spacing: 0.05em; }
    .rms-track {
      position: relative; flex: 1; height: 6px;
      background: #1e2235; border-radius: 3px; overflow: visible;
    }
    .rms-fill {
      height: 100%; border-radius: 3px; background: #22c55e;
      width: 0%; transition: width 0.2s ease-out;
    }
    .rms-fill.silent { background: #334155; }
    .rms-threshold {
      position: absolute; top: -2px; bottom: -2px;
      width: 2px; background: #f59e0b; border-radius: 1px;
    }
    .rms-value { font-variant-numeric: tabular-nums; min-width: 4rem; text-align: right; }
    .rms-stats {
      font-variant-numeric: tabular-nums; min-width: 11rem;
      text-align: right; color: #334155; letter-spacing: 0.03em;
    }
    .rms-stats.active       { color: #475569; }
    .rms-stats.transcribing { color: #4ade80; }

    /* â”€â”€ Transcript pane â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .transcript-pane { display: flex; flex-direction: column; overflow: hidden; flex: 1; }

    .pane-header {
      padding: 0.65rem 1.5rem; font-size: 0.67rem; font-weight: 700;
      letter-spacing: 0.08em; text-transform: uppercase; color: #334155;
      border-bottom: 1px solid #1a1d27;
      display: flex; align-items: center; justify-content: space-between;
    }

    .clear-btn { background: none; color: #334155; font-size: 0.67rem; padding: 0.15rem 0.45rem; border-radius: 4px; }
    .clear-btn:hover { color: #64748b; background: #1e2235; }

    #transcript-feed {
      flex: 1; overflow-y: auto; padding: 0.9rem 1.4rem;
      display: flex; flex-direction: column; gap: 0.45rem; scroll-behavior: smooth;
    }

    .transcript-chunk {
      background: #14172280; border: 1px solid #1e2235;
      border-radius: 8px; padding: 0.55rem 0.85rem;
      animation: fadeIn 0.2s ease;
    }

    .chunk-meta { display: flex; align-items: center; gap: 0.45rem; margin-bottom: 0.28rem; }

    .speaker-tag {
      font-size: 0.65rem; font-weight: 700; padding: 1px 6px;
      border-radius: 3px; letter-spacing: 0.04em;
    }
    .speaker-tag.microphone { background: #172554; color: #60a5fa; }
    .speaker-tag.system     { background: #052e16; color: #4ade80; }

    .chunk-time { font-size: 0.62rem; color: #334155; font-variant-numeric: tabular-nums; }

    .confidence-bar {
      margin-left: auto; width: 32px; height: 2px;
      background: #1e2235; border-radius: 99px; overflow: hidden;
    }
    .confidence-bar-fill { height: 100%; background: #4f46e5; border-radius: 99px; }

    .chunk-text { font-size: 0.85rem; line-height: 1.55; color: #cbd5e1; }

    .placeholder-text {
      color: #1e2235; font-size: 0.82rem; text-align: center;
      margin: auto; padding: 2rem; line-height: 1.8;
    }
    .placeholder-text strong { color: #2d3148; display: block; margin-bottom: 0.5rem; font-size: 0.88rem; }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeIn    { from { opacity: 0; transform: translateY(3px); } to { opacity: 1; transform: none; } }
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.25; } }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar       { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #1e2235; border-radius: 4px; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ğŸ§ </div>
    <span class="logo-text">MeetingMind</span>
  </div>
  <div class="status-pill">
    <div class="status-dot connecting" id="status-dot"></div>
    <span id="status-label">Connectingâ€¦</span>
    <button id="btn-reconnect" onclick="reconnectWS()">â†º Reconnect</button>
  </div>
</header>

<main>

  <!-- Controls bar -->
  <div class="controls">
    <button id="btn-start">â–¶ Start</button>
    <button id="btn-stop" disabled>â–  Stop</button>
    <button id="btn-reset" title="Force-clear stuck meeting state">â†º Reset</button>

    <div class="ctrl-sep"></div>

    <span class="ctrl-label">Mic</span>
    <select class="ctrl-select" id="mic-select">
      <option value="">OS Default</option>
    </select>

    <div class="ctrl-sep"></div>

    <span class="ctrl-label">Model</span>
    <select class="ctrl-select" id="model-select">
      <option value="base" selected>base â€” real-time (~5s load)</option>
      <option value="small">small â€” better accuracy (~12s load)</option>
      <option value="medium">medium â€” best accuracy (~60s load)</option>
      <option value="large">large â€” most accurate (~100s load)</option>
    </select>

    <span class="elapsed" id="elapsed"></span>
  </div>

  <!-- RMS level meter -->
  <div id="rms-meter-wrap">
    <span class="rms-label">MIC</span>
    <div class="rms-track">
      <div class="rms-fill" id="rms-fill"></div>
      <div class="rms-threshold" id="rms-threshold-line"></div>
    </div>
    <span class="rms-value" id="rms-value">â€”</span>
    <span class="rms-stats" id="rms-stats"></span>
  </div>

  <!-- Error banner -->
  <div id="error-banner" class="error-banner" style="display:none">
    <span id="error-text"></span>
    <button onclick="clearError()">âœ•</button>
  </div>

  <!-- Live transcript -->
  <div class="transcript-pane">
    <div class="pane-header">
      Live Transcript
      <button class="clear-btn" onclick="clearTranscript()">Clear</button>
    </div>
    <div id="transcript-feed">
      <div class="placeholder-text">
        <strong>No transcript yet</strong>
        Click <em>Start</em> and speak into your microphone.<br>
        Chunks appear every 3 seconds, transcribed locally by Whisper.
      </div>
    </div>
  </div>

</main>

<script>
  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let ws                    = null;
  let wsReconnectTimer      = null;
  let meetingActive         = false;
  let elapsedSecs           = 0;
  let elapsedTimer          = null;
  let rmsWatchdogTimer      = null;
  let loadingCountdownTimer = null;

  const MODEL_LOAD_SECS = { tiny: 3, base: 5, small: 12, medium: 55, large: 100 };

  const API    = `${location.protocol}//${location.host}`;
  const WS_URL = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/transcribe`;

  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const feed         = document.getElementById('transcript-feed');
  const btnStart     = document.getElementById('btn-start');
  const btnStop      = document.getElementById('btn-stop');
  const statusDot    = document.getElementById('status-dot');
  const statusLabel  = document.getElementById('status-label');
  const elapsedEl    = document.getElementById('elapsed');
  const modelSel     = document.getElementById('model-select');
  const micSel       = document.getElementById('mic-select');
  const errorBanner  = document.getElementById('error-banner');
  const errorText    = document.getElementById('error-text');
  const rmsMeterWrap = document.getElementById('rms-meter-wrap');

  // â”€â”€ Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showError(msg) { errorText.textContent = msg; errorBanner.style.display = 'flex'; }
  function clearError()   { errorBanner.style.display = 'none'; errorText.textContent = ''; }

  // â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setStatus(state) {
    const map = {
      connecting:   ['connecting',   'Connectingâ€¦'],
      connected:    ['connected',    'Connected'],
      loading:      ['connecting',   'â—Œ Loading Whisperâ€¦'],
      live:         ['live',         'â— Live'],
      disconnected: ['disconnected', 'Disconnected'],
      error:        ['error',        'Connection error'],
    };
    const [dot, label] = map[state] || ['', state];
    statusDot.className     = `status-dot ${dot}`;
    statusLabel.textContent = label;
    document.getElementById('btn-reconnect').style.display =
      (state === 'disconnected' || state === 'error') ? 'inline-flex' : 'none';
  }

  // â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function connectWebSocket() {
    if (ws && ws.readyState <= WebSocket.OPEN) return;
    clearTimeout(wsReconnectTimer);
    setStatus('connecting');
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      clearTimeout(wsReconnectTimer);
      setStatus(meetingActive ? 'live' : 'connected');
    };

    ws.onmessage = (event) => {
      if (event.data === 'pong') return;
      let msg;
      try { msg = JSON.parse(event.data); } catch { return; }

      if (msg.type === 'rms') {
        updateRmsMeter(msg.rms, msg.threshold, msg.captured, msg.passed);
        return;
      }
      if (msg.type === 'model_ready') {
        stopLoadingCountdown();
        if (meetingActive) setStatus('live');
        const note = document.createElement('div');
        note.style.cssText = 'color:#4ade80;font-size:0.75rem;padding:0.4rem 0;';
        note.textContent = `âœ“ Whisper '${msg.model}' ready â€” speak to begin`;
        clearPlaceholder();
        feed.appendChild(note);
        feed.scrollTop = feed.scrollHeight;
        setTimeout(() => note.remove(), 4000);
        return;
      }
      if (msg.type === 'error') { showError('Pipeline: ' + msg.message); return; }

      // Transcript chunk
      if (msg.text !== undefined) appendChunk(msg);
    };

    ws.onerror = () => setStatus('error');
    ws.onclose = () => {
      ws = null;
      setStatus('disconnected');
      wsReconnectTimer = setTimeout(connectWebSocket, 6000);
    };
  }

  function reconnectWS() {
    clearTimeout(wsReconnectTimer);
    ws = null;
    connectWebSocket();
  }

  // â”€â”€ Whisper load countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function startLoadingCountdown(model) {
    stopLoadingCountdown();
    const est = MODEL_LOAD_SECS[model] || 20;
    let secsLeft = est;
    const tick = () => {
      statusLabel.textContent = `â—Œ Loading Whisper ${model} (~${Math.max(0, secsLeft)}s)`;
      secsLeft--;
    };
    tick();
    loadingCountdownTimer = setInterval(tick, 1000);
  }
  function stopLoadingCountdown() {
    clearInterval(loadingCountdownTimer);
    loadingCountdownTimer = null;
  }

  // â”€â”€ Device dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadDevices() {
    try {
      const res = await fetch(`${API}/devices`);
      if (!res.ok) return;
      const { devices } = await res.json();
      if (!devices || !devices.length) return;

      micSel.innerHTML = '<option value="">OS Default</option>';
      devices.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.index;
        opt.textContent = `[${d.index}] ${d.name.slice(0, 40)}`;
        if (d.is_default) opt.selected = true;
        micSel.appendChild(opt);
      });
    } catch (err) {
      console.warn('Device fetch failed:', err);
    }
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    try { await fetch(`${API}/meeting/reset`, { method: 'POST' }); } catch (_) {}
    connectWebSocket();
    await loadDevices();

    try {
      const res = await fetch(`${API}/health`);
      if (!res.ok) return;
      const data = await res.json();
      if (data.meeting_active) {
        meetingActive              = true;
        btnStart.disabled          = true;
        btnStop.disabled           = false;
        modelSel.disabled          = true;
        micSel.disabled            = true;
        rmsMeterWrap.style.display = 'flex';
        setStatus(data.model_loading ? 'loading' : 'live');
      }
    } catch (_) {}
  }

  // â”€â”€ Meeting controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startMeeting() {
    clearError();
    btnStart.disabled          = true;
    btnStart.textContent       = 'â—Œ Startingâ€¦';
    btnStop.disabled           = false;
    modelSel.disabled          = true;
    micSel.disabled            = true;
    rmsMeterWrap.style.display = 'flex';

    const model  = modelSel.value;
    const micIdx = micSel.value;
    let url = `${API}/meeting/start?model_size=${model}`;
    if (micIdx) url += `&mic_device_index=${micIdx}`;

    try {
      const res = await fetch(url, { method: 'POST' });
      if (!res.ok) {
        const err  = await res.json().catch(() => ({}));
        const hint = err.suggestion ? ` â€” ${err.suggestion}` : '';
        showError(`Failed to start: ${err.error || res.statusText}${hint}`);
        btnStart.disabled          = false;
        btnStart.textContent       = 'â–¶ Start';
        btnStop.disabled           = true;
        modelSel.disabled          = false;
        micSel.disabled            = false;
        rmsMeterWrap.style.display = 'none';
        return;
      }
    } catch (e) {
      showError('Server unreachable â€” is uvicorn running?');
      btnStart.disabled          = false;
      btnStart.textContent       = 'â–¶ Start';
      btnStop.disabled           = true;
      modelSel.disabled          = false;
      micSel.disabled            = false;
      rmsMeterWrap.style.display = 'none';
      return;
    }

    meetingActive        = true;
    btnStart.textContent = 'â–¶ Start';
    elapsedSecs          = 0;
    elapsedTimer = setInterval(() => {
      elapsedSecs++;
      const m = String(Math.floor(elapsedSecs / 60)).padStart(2, '0');
      const s = String(elapsedSecs % 60).padStart(2, '0');
      elapsedEl.textContent = `${m}:${s}`;
    }, 1000);

    if (ws && ws.readyState === WebSocket.OPEN) {
      setStatus('loading');
      startLoadingCountdown(model);
    } else {
      connectWebSocket();
    }
  }

  async function stopMeeting() {
    clearInterval(elapsedTimer);
    clearTimeout(rmsWatchdogTimer);
    stopLoadingCountdown();
    meetingActive = false;

    fetch(`${API}/meeting/stop`, { method: 'POST' }).catch(() => {});

    btnStart.disabled             = false;
    btnStart.textContent          = 'â–¶ Start';
    btnStop.disabled              = true;
    modelSel.disabled             = false;
    micSel.disabled               = false;
    elapsedEl.textContent         = '';
    rmsMeterWrap.style.display    = 'none';
    document.getElementById('rms-stats').textContent = '';
    setStatus(ws && ws.readyState === WebSocket.OPEN ? 'connected' : 'disconnected');
  }

  async function resetMeeting() {
    clearInterval(elapsedTimer);
    clearTimeout(rmsWatchdogTimer);
    stopLoadingCountdown();
    meetingActive = false;

    try { await fetch(`${API}/meeting/reset`, { method: 'POST' }); } catch (_) {}

    btnStart.disabled             = false;
    btnStart.textContent          = 'â–¶ Start';
    btnStop.disabled              = true;
    modelSel.disabled             = false;
    micSel.disabled               = false;
    elapsedEl.textContent         = '';
    rmsMeterWrap.style.display    = 'none';
    document.getElementById('rms-stats').textContent = '';
    setStatus(ws && ws.readyState === WebSocket.OPEN ? 'connected' : 'disconnected');
  }

  // â”€â”€ Transcript rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearPlaceholder() {
    const ph = feed.querySelector('.placeholder-text');
    if (ph) ph.remove();
  }

  function appendChunk(chunk) {
    clearPlaceholder();
    const t       = new Date(chunk.timestamp * 1000).toLocaleTimeString();
    const conf    = Math.round((chunk.confidence || 0) * 100);
    const src     = chunk.source || 'microphone';
    const speaker = src === 'microphone' ? 'You' : 'Them';
    const tooltip = src === 'microphone'
      ? 'Your microphone'
      : 'Them = remote audio playing through your speakers';

    const el = document.createElement('div');
    el.className = 'transcript-chunk';
    el.innerHTML = `
      <div class="chunk-meta">
        <span class="speaker-tag ${escHtml(src)}" title="${escHtml(tooltip)}">[${escHtml(speaker)}]</span>
        <span class="chunk-time">${t}</span>
        <div class="confidence-bar" title="Confidence: ${conf}%">
          <div class="confidence-bar-fill" style="width:${conf}%"></div>
        </div>
      </div>
      <div class="chunk-text">${escHtml(chunk.text)}</div>
    `;
    feed.appendChild(el);
    feed.scrollTop = feed.scrollHeight;
  }

  function clearTranscript() { feed.innerHTML = ''; }

  // â”€â”€ RMS meter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateRmsMeter(rms, threshold, captured, passed) {
    clearTimeout(rmsWatchdogTimer);
    if (meetingActive) {
      rmsWatchdogTimer = setTimeout(() => {
        document.getElementById('rms-value').textContent = 'âš  signal lost';
        document.getElementById('rms-fill').style.width = '0%';
      }, 3000);
    }

    const db    = 20 * Math.log10(Math.max(rms, 1e-9));
    const pct   = Math.max(0, Math.min(100, (80 + db) / 80 * 100));
    const thDb  = 20 * Math.log10(Math.max(threshold, 1e-9));
    const thPct = Math.max(0, Math.min(100, (80 + thDb) / 80 * 100));

    document.getElementById('rms-fill').style.width = pct + '%';
    document.getElementById('rms-fill').classList.toggle('silent', rms < threshold);
    document.getElementById('rms-threshold-line').style.left = thPct + '%';
    document.getElementById('rms-value').textContent = rms < 0.00001 ? 'â€”' : rms.toFixed(5);

    if (captured !== undefined) {
      const statsEl = document.getElementById('rms-stats');
      statsEl.textContent = passed > 0
        ? `${captured} captured Â· ${passed} transcribed`
        : captured > 0 ? `${captured} captured Â· 0 transcribed` : '';
      statsEl.className = `rms-stats ${passed > 0 ? 'transcribing' : captured > 0 ? 'active' : ''}`;
    }
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function escHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  btnStart.addEventListener('click', startMeeting);
  btnStop.addEventListener('click',  stopMeeting);
  document.getElementById('btn-reset').addEventListener('click', resetMeeting);

  init();
</script>
</body>
</html>
